DROP DATABASE PROVEEDORES
CREATE DATABASE PROVEEDORES

USE PROVEEDORES;


CREATE TABLE TIPO_USUARIO
(
ID_TIPO_USUSARIO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(50) NOT NULL
);


CREATE TABLE INTANCIA_REGISTRAL
(
ID_INSTANCIA_REGISTRAL INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(50)
);


CREATE TABLE USUARIOS
(
ID_USUARIO INT NOT NULL PRIMARY KEY auto_increment,
NOMBRE VARCHAR (50) NOT NULL, 
CUIL BIGINT NOT NULL,
TIPO_USUARIO INT NOT NULL,
ESTADO BIT NOT NULL,
FOREIGN KEY (TIPO_USUARIO) REFERENCES TIPO_USUARIO (ID_TIPO_USUSARIO)
);

CREATE TABLE EMPLEADOS 
(
ID_EMPLEADO INT NOT NULL PRIMARY KEY auto_increment,
ID_EMPRESA INT NOT NULL,
ID_INSTANCIA_REGISTRAL INT NOT NULL,
NOMBRE VARCHAR (50) NOT NULL,
APELLIDO VARCHAR (50) NOT NULL,
ESTADO BIT NOT NULL,
DNI INT NOT NULL,
CUIT BIGINT NOT NULL,
CAPACITACION DATE, 
ENTREGA_EPP DATE,
APTO_MEDICO DATE,
MONOTRIBUTO DATE,

FOREIGN KEY (ID_EMPRESA) REFERENCES USUARIOS (ID_USUARIO),
FOREIGN KEY (ID_INSTANCIA_REGISTRAL) REFERENCES INTANCIA_REGISTRAL (ID_INSTANCIA_REGISTRAL),
CONSTRAINT chk_dni CHECK (DNI > 10000000 AND DNI < 99999999)


);

INSERT TIPO_USUARIO (NOMBRE)
VALUES ('ADMINISTRADOR'),
('VIGILADOR'),
('PROVEEDOR');

INSERT INTANCIA_REGISTRAL (NOMBRE)
VALUES ('RELACION DE DEPENDENCIA'),
 ('RESPONSABLE INSCRIPTO'),
 ('MONOTRIBUTISTA');
 
 
 INSERT INTO USUARIOS (NOMBRE, CUIL, TIPO_USUARIO, ESTADO) VALUES
('Empresa A', 20345678901, 3, 1),
('Empresa B', 20345678902, 3, 1),
('Empresa C', 20345678903, 3, 1);

INSERT INTO EMPLEADOS (ID_EMPRESA, ID_INSTANCIA_REGISTRAL, NOMBRE, APELLIDO, ESTADO, DNI, CUIT, CAPACITACION, ENTREGA_EPP, APTO_MEDICO, MONOTRIBUTO)
VALUES
-- Empleados de Empresa A
(1, 1, 'Juan', 'PÃ©rez', 1, 30123456, 20301234561, '2024-01-10', '2024-02-15', '2024-03-20', '2024-04-25'),
(1, 1, 'MarÃ­a', 'GÃ³mez', 1, 31234567, 20312345672, '2024-01-11', '2024-02-16', '2024-03-21', '2024-04-26'),
(1, 1, 'Carlos', 'LÃ³pez', 1, 32345678, 20323456783, '2024-01-12', '2024-02-17', '2024-03-22', '2024-04-27'),
(1, 1, 'Ana', 'MartÃ­nez', 1, 33456789, 20334567894, '2024-01-13', '2024-02-18', '2024-03-23', '2024-04-28'),
(1, 1, 'Luis', 'DÃ­az', 1, 34567890, 20345678905, '2024-01-14', '2024-02-19', '2024-03-24', '2024-04-29'),

-- Empleados de Empresa B
(2, 1, 'SofÃ­a', 'FernÃ¡ndez', 1, 35678901, 20356789016, '2024-01-15', '2024-02-20', '2024-03-25', '2024-04-30'),
(2, 1, 'Javier', 'GarcÃ­a', 1, 36789012, 20367890127, '2024-01-16', '2024-02-21', '2024-03-26', '2024-05-01'),
(2, 1, 'Elena', 'RodrÃ­guez', 1, 37890123, 20378901238, '2024-01-17', '2024-02-22', '2024-03-27', '2024-05-02'),
(2, 1, 'Pedro', 'SÃ¡nchez', 1, 38901234, 20389012349, '2024-01-18', '2024-02-23', '2024-03-28', '2024-05-03'),
(2, 1, 'Gabriela', 'Torres', 1, 39012345, 20390123450, '2024-01-19', '2024-02-24', '2024-03-29', '2024-05-04'),

-- Empleados de Empresa C
(3, 1, 'Ricardo', 'Molina', 1, 40123456, 20401234561, '2024-01-20', '2024-02-25', '2024-03-30', '2024-05-05'),
(3, 2, 'Cecilia', 'Ramos', 1, 41234567, 20412345672, '2024-01-21', '2024-02-26', '2024-03-31', '2024-05-06'),
(3, 1, 'HÃ©ctor', 'GimÃ©nez', 1, 42345678, 20423456783, '2024-01-22', '2024-02-27', '2024-04-01', '2024-05-07'),
(3, 1, 'Natalia', 'Ortiz', 1, 43456789, 20434567894, '2024-01-23', '2024-02-28', '2024-04-02', '2024-05-08'),
(3, 1, 'Emiliano', 'Silva', 1, 44567890, 20445678905, '2024-01-24', '2024-02-29', '2024-04-03', '2024-05-09');

select * from USUARIOS

DELIMITER $$

CREATE TRIGGER en_lugar_de_eliminar_usuario
BEFORE DELETE ON USUARIOS
FOR EACH ROW
BEGIN
    -- En lugar de eliminar, desactivamos el usuario
    UPDATE USUARIOS SET ESTADO = 0 WHERE ID_USUARIO = OLD.ID_USUARIO;

    -- Cancelamos la eliminaciÃ³n real
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'ðŸš« EliminaciÃ³n cancelada: El usuario ha sido desactivado.';
END $$

DELIMITER ;



